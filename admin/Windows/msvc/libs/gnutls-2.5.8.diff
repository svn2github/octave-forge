diff -ur gnutls-2.5.8/config.h.in gnutls-2.5.8-new/config.h.in
--- gnutls-2.5.8/config.h.in	Sun Sep 21 12:42:45 2008
+++ gnutls-2.5.8-new/config.h.in	Tue Sep 23 13:44:17 2008
@@ -634,3 +634,9 @@
 
 /* Define as a macro for copying va_list variables. */
 #undef va_copy
+
+#ifdef NO_SSIZE_T
+typedef int ssize_t;
+typedef int mode_t;
+typedef int pid_t;
+#endif
diff -ur gnutls-2.5.8/configure gnutls-2.5.8-new/configure
--- gnutls-2.5.8/configure	Sun Sep 21 12:42:44 2008
+++ gnutls-2.5.8-new/configure	Tue Sep 23 12:15:42 2008
@@ -9825,7 +9825,7 @@
 
 
 cat >>confdefs.h <<\_ACEOF
-#define HAVE_STRINGS_H 1
+/*#define HAVE_STRINGS_H 1*/
 _ACEOF
 
 
@@ -15508,8 +15508,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_sys_socket_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/sys/socket.h#{
-		 s#.*"\(.*/sys/socket.h\)".*#\1#
+	       sed -n '\#[/\\]sys/socket.h#{
+		 s#.*"\(.*[/\\]sys/socket.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -16847,8 +16847,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_errno_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/errno.h#{
-		 s#.*"\(.*/errno.h\)".*#\1#
+	       sed -n '\#[/\\]errno.h#{
+		 s#.*"\(.*[/\\]errno.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -18555,8 +18555,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_arpa_inet_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/arpa/inet.h#{
-		 s#.*"\(.*/arpa/inet.h\)".*#\1#
+	       sed -n '\#[/\\]arpa/inet.h#{
+		 s#.*"\(.*[/\\]arpa/inet.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -18892,6 +18892,7 @@
 /* end confdefs.h.  */
 
 #ifdef HAVE_WS2TCPIP_H
+#include <winsock2.h>
 #include <ws2tcpip.h>
 #endif
 #include <stddef.h>
@@ -18980,6 +18981,7 @@
 #include <netdb.h>
 #endif
 #ifdef HAVE_WS2TCPIP_H
+#include <winsock2.h>
 #include <ws2tcpip.h>
 #endif
 #include <stddef.h>
@@ -19424,6 +19426,7 @@
 #include <netdb.h>
 #endif
 #ifdef HAVE_WS2TCPIP_H
+#include <winsock2.h>
 #include <ws2tcpip.h>
 #endif
 
@@ -19506,6 +19509,7 @@
 #include <netdb.h>
 #endif
 #ifdef HAVE_WS2TCPIP_H
+#include <winsock2.h>
 #include <ws2tcpip.h>
 #endif
 
@@ -19588,6 +19592,7 @@
 #include <netdb.h>
 #endif
 #ifdef HAVE_WS2TCPIP_H
+#include <winsock2.h>
 #include <ws2tcpip.h>
 #endif
 
@@ -19670,6 +19675,7 @@
 #include <netdb.h>
 #endif
 #ifdef HAVE_WS2TCPIP_H
+#include <winsock2.h>
 #include <ws2tcpip.h>
 #endif
 
@@ -19752,6 +19758,7 @@
 #include <netdb.h>
 #endif
 #ifdef HAVE_WS2TCPIP_H
+#include <winsock2.h>
 #include <ws2tcpip.h>
 #endif
 
@@ -19798,6 +19805,7 @@
 #include <netdb.h>
 #endif
 #ifdef HAVE_WS2TCPIP_H
+#include <winsock2.h>
 #include <ws2tcpip.h>
 #endif
 
@@ -21507,8 +21515,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_netinet_in_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/netinet/in.h#{
-		 s#.*"\(.*/netinet/in.h\)".*#\1#
+	       sed -n '\#[/\\]netinet/in.h#{
+		 s#.*"\(.*[/\\]netinet/in.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -22317,6 +22325,7 @@
       #if HAVE_SYS_SOCKET_H
       # include <sys/socket.h>
       #elif HAVE_WS2TCPIP_H
+#include <winsock2.h>
       # include <ws2tcpip.h>
       #endif
 
@@ -22357,6 +22366,7 @@
       #if HAVE_SYS_SOCKET_H
       # include <sys/socket.h>
       #elif HAVE_WS2TCPIP_H
+#include <winsock2.h>
       # include <ws2tcpip.h>
       #endif
 
@@ -22599,8 +22609,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_stdarg_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/stdarg.h#{
-		 s#.*"\(.*/stdarg.h\)".*#\1#
+	       sed -n '\#[/\\]stdarg.h#{
+		 s#.*"\(.*[/\\]stdarg.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -24118,8 +24128,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_string_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/string.h#{
-		 s#.*"\(.*/string.h\)".*#\1#
+	       sed -n '\#[/\\]string.h#{
+		 s#.*"\(.*[/\\]string.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -24176,8 +24186,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_strings_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/strings.h#{
-		 s#.*"\(.*/strings.h\)".*#\1#
+	       sed -n '\#[/\\]strings.h#{
+		 s#.*"\(.*[/\\]strings.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -24454,8 +24464,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_time_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/time.h#{
-		 s#.*"\(.*/time.h\)".*#\1#
+	       sed -n '\#[/\\]time.h#{
+		 s#.*"\(.*[/\\]time.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -25200,8 +25210,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_float_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/float.h#{
-		 s#.*"\(.*/float.h\)".*#\1#
+	       sed -n '\#[/\\]float.h#{
+		 s#.*"\(.*[/\\]float.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -27365,6 +27375,7 @@
       #if HAVE_SYS_SOCKET_H
       # include <sys/socket.h>
       #elif HAVE_WS2TCPIP_H
+#include <winsock2.h>
       # include <ws2tcpip.h>
       #endif
 
@@ -27405,6 +27416,7 @@
       #if HAVE_SYS_SOCKET_H
       # include <sys/socket.h>
       #elif HAVE_WS2TCPIP_H
+#include <winsock2.h>
       # include <ws2tcpip.h>
       #endif
 
@@ -27616,8 +27628,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_stdint_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/stdint.h#{
-		 s#.*"\(.*/stdint.h\)".*#\1#
+	       sed -n '\#[/\\]stdint.h#{
+		 s#.*"\(.*[/\\]stdint.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -28669,8 +28681,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_stdio_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/stdio.h#{
-		 s#.*"\(.*/stdio.h\)".*#\1#
+	       sed -n '\#[/\\]stdio.h#{
+		 s#.*"\(.*[/\\]stdio.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -28721,8 +28733,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_stdlib_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/stdlib.h#{
-		 s#.*"\(.*/stdlib.h\)".*#\1#
+	       sed -n '\#[/\\]stdlib.h#{
+		 s#.*"\(.*[/\\]stdlib.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -29440,8 +29452,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_sys_socket_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/sys/socket.h#{
-		 s#.*"\(.*/sys/socket.h\)".*#\1#
+	       sed -n '\#[/\\]sys/socket.h#{
+		 s#.*"\(.*[/\\]sys/socket.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -29726,8 +29738,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_sys_stat_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/sys/stat.h#{
-		 s#.*"\(.*/sys/stat.h\)".*#\1#
+	       sed -n '\#[/\\]sys/stat.h#{
+		 s#.*"\(.*[/\\]sys/stat.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -30017,8 +30029,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_unistd_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/unistd.h#{
-		 s#.*"\(.*/unistd.h\)".*#\1#
+	       sed -n '\#[/\\]unistd.h#{
+		 s#.*"\(.*[/\\]unistd.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
@@ -30662,8 +30674,8 @@
 
 _ACEOF
 	    	    	    	    gl_cv_next_wchar_h='"'`(eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-	       sed -n '\#/wchar.h#{
-		 s#.*"\(.*/wchar.h\)".*#\1#
+	       sed -n '\#[/\\]wchar.h#{
+		 s#.*"\(.*[/\\]wchar.h\)".*#\1#
 		 s#^/[^/]#//&#
 		 p
 		 q
diff -ur gnutls-2.5.8/includes/gnutls/gnutls.h.in gnutls-2.5.8-new/includes/gnutls/gnutls.h.in
--- gnutls-2.5.8/includes/gnutls/gnutls.h.in	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/includes/gnutls/gnutls.h.in	Tue Sep 23 13:40:38 2008
@@ -41,6 +41,12 @@
 {
 #endif
 
+#ifdef GNUTLS_INTERNAL
+#define GNUTLS_API __declspec(dllexport)
+#else
+#define GNUTLS_API __declspec(dllimport)
+#endif
+
 #define LIBGNUTLS_VERSION "@VERSION@"
 
 #define LIBGNUTLS_VERSION_MAJOR @MAJOR_VERSION@
@@ -811,11 +817,11 @@
 					gnutls_free_function gt_free_func);
 
 /* For use in callbacks */
-  extern gnutls_alloc_function gnutls_malloc;
-  extern gnutls_alloc_function gnutls_secure_malloc;
-  extern gnutls_realloc_function gnutls_realloc;
-  extern gnutls_calloc_function gnutls_calloc;
-  extern gnutls_free_function gnutls_free;
+  extern GNUTLS_API gnutls_alloc_function gnutls_malloc;
+  extern GNUTLS_API gnutls_alloc_function gnutls_secure_malloc;
+  extern GNUTLS_API gnutls_realloc_function gnutls_realloc;
+  extern GNUTLS_API gnutls_calloc_function gnutls_calloc;
+  extern GNUTLS_API gnutls_free_function gnutls_free;
 
   extern char *(*gnutls_strdup) (const char *);
 
diff -ur gnutls-2.5.8/lgl/sys_stat.in.h gnutls-2.5.8-new/lgl/sys_stat.in.h
--- gnutls-2.5.8/lgl/sys_stat.in.h	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lgl/sys_stat.in.h	Tue Sep 23 12:45:27 2008
@@ -35,6 +35,7 @@
    headers that may declare mkdir().  */
 #if (defined _WIN32 || defined __WIN32__) && ! defined __CYGWIN__
 # include <io.h>
+# include <direct.h>
 #endif
 
 #ifndef S_IFMT
diff -ur gnutls-2.5.8/lib/Makefile.in gnutls-2.5.8-new/lib/Makefile.in
--- gnutls-2.5.8/lib/Makefile.in	Sun Sep 21 12:42:48 2008
+++ gnutls-2.5.8-new/lib/Makefile.in	Tue Sep 23 13:41:42 2008
@@ -697,7 +697,7 @@
 	-I$(top_builddir)/lgl -I$(top_srcdir)/includes -I../includes \
 	-I$(srcdir)/x509 -I$(top_srcdir)/libextra \
 	-I$(top_srcdir)/lib/openpgp/ $(am__append_3) $(am__append_4) \
-	$(am__append_5) $(LIBGCRYPT_CFLAGS)
+	$(am__append_5) $(LIBGCRYPT_CFLAGS) -DGNUTLS_INTERNAL
 bin_SCRIPTS = libgnutls-config
 m4datadir = $(datadir)/aclocal
 dist_m4data_DATA = libgnutls.m4
@@ -752,7 +752,7 @@
 libgnutls_la_SOURCES = $(HFILES) $(COBJECTS) $(SRP_COBJECTS)	\
 	$(PSK_COBJECTS) gnutls.asn pkix.asn libgnutls.vers
 
-libgnutls_la_LDFLAGS = -no-undefined -version-info \
+libgnutls_la_LDFLAGS = -export-symbols-regex "^_?gnutls_.*" -no-undefined -version-info \
 	$(LT_CURRENT):$(LT_REVISION):$(LT_AGE) $(am__append_9) \
 	$(am__append_11) $(am__append_12)
 libgnutls_la_LIBADD = ../lgl/liblgnu.la x509/libgnutls_x509.la \
diff -ur gnutls-2.5.8/lib/cipher-libgcrypt.c gnutls-2.5.8-new/lib/cipher-libgcrypt.c
--- gnutls-2.5.8/lib/cipher-libgcrypt.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lib/cipher-libgcrypt.c	Tue Sep 23 13:12:13 2008
@@ -155,10 +155,10 @@
 int crypto_cipher_prio = INT_MAX;
 
 gnutls_crypto_cipher_st _gnutls_cipher_ops = {
-  .init = wrap_gcry_cipher_init,
-  .setkey = wrap_gcry_cipher_setkey,
-  .setiv = wrap_gcry_cipher_setiv,
-  .encrypt = wrap_gcry_cipher_encrypt,
-  .decrypt = wrap_gcry_cipher_decrypt,
-  .deinit = wrap_gcry_cipher_close,
+  wrap_gcry_cipher_init,
+  wrap_gcry_cipher_setkey,
+  wrap_gcry_cipher_setiv,
+  wrap_gcry_cipher_encrypt,
+  wrap_gcry_cipher_decrypt,
+  gcry_cipher_close,
 };
diff -ur gnutls-2.5.8/lib/gnutls_mpi.h gnutls-2.5.8-new/lib/gnutls_mpi.h
--- gnutls-2.5.8/lib/gnutls_mpi.h	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lib/gnutls_mpi.h	Tue Sep 23 12:37:29 2008
@@ -31,7 +31,7 @@
 # include <gnutls/crypto.h>
 
 extern int crypto_bigint_prio;
-extern gnutls_crypto_bigint_st _gnutls_mpi_ops;
+extern GNUTLS_API gnutls_crypto_bigint_st _gnutls_mpi_ops;
 
 bigint_t _gnutls_mpi_randomize( bigint_t, unsigned int bits, gnutls_rnd_level_t level);
 
diff -ur gnutls-2.5.8/lib/mac-libgcrypt.c gnutls-2.5.8-new/lib/mac-libgcrypt.c
--- gnutls-2.5.8/lib/mac-libgcrypt.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lib/mac-libgcrypt.c	Tue Sep 23 13:12:56 2008
@@ -162,21 +162,21 @@
 int crypto_mac_prio = INT_MAX;
 
 gnutls_crypto_mac_st _gnutls_mac_ops = {
-  .init = wrap_gcry_mac_init,
-  .setkey = wrap_gcry_md_setkey,
-  .hash = wrap_gcry_md_write,
-  .copy = wrap_gcry_md_copy,
-  .output = wrap_gcry_mac_output,
-  .deinit = wrap_gcry_md_close,
+  wrap_gcry_mac_init,
+  gcry_md_setkey,
+  gcry_md_write,
+  gcry_md_copy,
+  wrap_gcry_mac_output,
+  gcry_md_close,
 };
 
 int crypto_digest_prio = INT_MAX;
 
 gnutls_crypto_digest_st _gnutls_digest_ops = {
-  .init = wrap_gcry_hash_init,
-  .setkey = NULL,
-  .hash = wrap_gcry_md_write,
-  .copy = wrap_gcry_md_copy,
-  .output = wrap_gcry_mac_output,
-  .deinit = wrap_gcry_md_close,
+  wrap_gcry_hash_init,
+  NULL,
+  gcry_md_write,
+  gcry_md_copy,
+  wrap_gcry_mac_output,
+  gcry_md_close,
 };
diff -ur gnutls-2.5.8/lib/minitasn1/Makefile.in gnutls-2.5.8-new/lib/minitasn1/Makefile.in
--- gnutls-2.5.8/lib/minitasn1/Makefile.in	Sun Sep 21 12:42:48 2008
+++ gnutls-2.5.8-new/lib/minitasn1/Makefile.in	Tue Sep 23 13:41:58 2008
@@ -560,7 +560,8 @@
 xgl_LTLIBOBJS = @xgl_LTLIBOBJS@
 xgltests_LIBOBJS = @xgltests_LIBOBJS@
 xgltests_LTLIBOBJS = @xgltests_LTLIBOBJS@
-AM_CPPFLAGS = -I$(top_srcdir)/lib -I$(top_srcdir)/lgl -I$(top_builddir)/lgl
+AM_CPPFLAGS = -I$(top_srcdir)/lib -I$(top_srcdir)/lgl -I$(top_builddir)/lgl \
+	      -DGNUTLS_INTERNAL
 noinst_LTLIBRARIES = libminitasn1.la
 libminitasn1_la_SOURCES = libtasn1.h gstr.h errors.h int.h		\
         parser_aux.h structure.h element.h decoding.c gstr.c errors.c	\
diff -ur gnutls-2.5.8/lib/mpi-libgcrypt.c gnutls-2.5.8-new/lib/mpi-libgcrypt.c
--- gnutls-2.5.8/lib/mpi-libgcrypt.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lib/mpi-libgcrypt.c	Tue Sep 23 13:10:48 2008
@@ -390,27 +390,27 @@
 int crypto_bigint_prio = INT_MAX;
 
 gnutls_crypto_bigint_st _gnutls_mpi_ops = {
-  .bigint_new = wrap_gcry_mpi_new,
-  .bigint_cmp = wrap_gcry_mpi_cmp,
-  .bigint_cmp_ui = wrap_gcry_mpi_cmp_ui,
-  .bigint_mod = wrap_gcry_mpi_mod,
-  .bigint_set = wrap_gcry_mpi_set,
-  .bigint_set_ui = wrap_gcry_mpi_set_ui,
-  .bigint_get_nbits = wrap_gcry_mpi_get_nbits,
-  .bigint_powm = wrap_gcry_mpi_powm,
-  .bigint_addm = wrap_gcry_mpi_addm,
-  .bigint_subm = wrap_gcry_mpi_subm,
-  .bigint_add = wrap_gcry_mpi_add,
-  .bigint_sub = wrap_gcry_mpi_sub,
-  .bigint_add_ui = wrap_gcry_mpi_add_ui,
-  .bigint_sub_ui = wrap_gcry_mpi_sub_ui,
-  .bigint_mul = wrap_gcry_mpi_mul,
-  .bigint_mulm = wrap_gcry_mpi_mulm,
-  .bigint_mul_ui = wrap_gcry_mpi_mul_ui,
-  .bigint_div = wrap_gcry_mpi_div,
-  .bigint_prime_check = wrap_gcry_prime_check,
-  .bigint_release = wrap_gcry_mpi_release,
-  .bigint_print = wrap_gcry_mpi_print,
-  .bigint_scan = wrap_gcry_mpi_scan,
-  .bigint_generate_group = wrap_gcry_generate_group
+   gcry_mpi_new,
+   gcry_mpi_release,
+   gcry_mpi_cmp,
+   gcry_mpi_cmp_ui,
+   wrap_gcry_mpi_mod,
+   gcry_mpi_set,
+   gcry_mpi_set_ui,
+   gcry_mpi_get_nbits,
+   wrap_gcry_mpi_powm,
+   wrap_gcry_mpi_addm,
+   wrap_gcry_mpi_subm,
+   wrap_gcry_mpi_mulm,
+   wrap_gcry_mpi_add,
+   wrap_gcry_mpi_sub,
+   wrap_gcry_mpi_mul,
+   wrap_gcry_mpi_add_ui,
+   wrap_gcry_mpi_sub_ui,
+   wrap_gcry_mpi_mul_ui,
+   wrap_gcry_mpi_div,
+   wrap_gcry_prime_check,
+   wrap_gcry_generate_group,
+   wrap_gcry_mpi_scan,
+   wrap_gcry_mpi_print
 };
diff -ur gnutls-2.5.8/lib/opencdk/Makefile.in gnutls-2.5.8-new/lib/opencdk/Makefile.in
--- gnutls-2.5.8/lib/opencdk/Makefile.in	Sun Sep 21 12:42:48 2008
+++ gnutls-2.5.8-new/lib/opencdk/Makefile.in	Tue Sep 23 13:42:12 2008
@@ -566,7 +566,8 @@
 xgltests_LTLIBOBJS = @xgltests_LTLIBOBJS@
 AM_CPPFLAGS = -I$(top_srcdir)/lib -I$(top_srcdir)/includes \
 	-I$(top_builddir)/includes -I$(top_srcdir)/lgl \
-	-I$(top_builddir)/lgl $(am__append_1) $(am__append_2)
+	-I$(top_builddir)/lgl $(am__append_1) $(am__append_2) \
+	-DGNUTLS_INTERNAL
 noinst_LTLIBRARIES = libminiopencdk.la
 libminiopencdk_la_SOURCES = armor.c filters.h keydb.h main.c types.h	\
 	kbnode.c main.h packet.h dummy.c sig-check.c verify.c hash.c \
diff -ur gnutls-2.5.8/lib/opencdk/dummy.c gnutls-2.5.8-new/lib/opencdk/dummy.c
--- gnutls-2.5.8/lib/opencdk/dummy.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lib/opencdk/dummy.c	Tue Sep 23 12:50:45 2008
@@ -1,3 +1,6 @@
+#ifdef HAVE_CONFIG_H
+# include <config.h>
+#endif
 #include <stdio.h>
 #include <string.h>
 
diff -ur gnutls-2.5.8/lib/opencdk/main.c gnutls-2.5.8-new/lib/opencdk/main.c
--- gnutls-2.5.8/lib/opencdk/main.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lib/opencdk/main.c	Tue Sep 23 12:49:46 2008
@@ -30,6 +30,7 @@
 # include <unistd.h>
 #endif
 #ifdef _WIN32
+#define WIN32_LEAN_AND_MEAN
 #include <windows.h>
 #endif
 
diff -ur gnutls-2.5.8/lib/openpgp/Makefile.in gnutls-2.5.8-new/lib/openpgp/Makefile.in
--- gnutls-2.5.8/lib/openpgp/Makefile.in	Sun Sep 21 12:42:48 2008
+++ gnutls-2.5.8-new/lib/openpgp/Makefile.in	Tue Sep 23 13:42:27 2008
@@ -565,7 +565,8 @@
 xgltests_LTLIBOBJS = @xgltests_LTLIBOBJS@
 AM_CPPFLAGS = -I$(top_srcdir)/lgl -I$(top_builddir)/lgl \
 	-I$(top_srcdir)/lib -I$(top_srcdir)/includes -I../../includes \
-	-I$(top_srcdir)/lib/opencdk $(am__append_1) $(am__append_2)
+	-I$(top_srcdir)/lib/opencdk $(am__append_1) $(am__append_2) \
+	-DGNUTLS_INTERNAL
 noinst_LTLIBRARIES = libgnutls_openpgp.la
 COBJECTS = pgp.c pgpverify.c extras.c compat.c privkey.c output.c	\
 	gnutls_openpgp.c
diff -ur gnutls-2.5.8/lib/pk-libgcrypt.c gnutls-2.5.8-new/lib/pk-libgcrypt.c
--- gnutls-2.5.8/lib/pk-libgcrypt.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lib/pk-libgcrypt.c	Tue Sep 23 13:07:34 2008
@@ -826,10 +826,10 @@
 int crypto_pk_prio = INT_MAX;
 
 gnutls_crypto_pk_st _gnutls_pk_ops = {
-  .encrypt = _wrap_gcry_pk_encrypt,
-  .decrypt = _wrap_gcry_pk_decrypt,
-  .sign = _wrap_gcry_pk_sign,
-  .verify = _wrap_gcry_pk_verify,
-  .generate = wrap_gcry_pk_generate_params,
-  .pk_fixup_private_params = wrap_gcry_pk_fixup,
+  _wrap_gcry_pk_encrypt,
+  _wrap_gcry_pk_decrypt,
+  _wrap_gcry_pk_sign,
+  _wrap_gcry_pk_verify,
+  wrap_gcry_pk_generate_params,
+  wrap_gcry_pk_fixup,
 };
diff -ur gnutls-2.5.8/lib/rnd-libgcrypt.c gnutls-2.5.8-new/lib/rnd-libgcrypt.c
--- gnutls-2.5.8/lib/rnd-libgcrypt.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/lib/rnd-libgcrypt.c	Tue Sep 23 13:11:40 2008
@@ -57,7 +57,7 @@
 int crypto_rnd_prio = INT_MAX;
 
 gnutls_crypto_rnd_st _gnutls_rnd_ops = {
-  .init = wrap_gcry_rnd_init,
-  .deinit = NULL,
-  .rnd = wrap_gcry_rnd,
+  wrap_gcry_rnd_init,
+  wrap_gcry_rnd,
+  NULL
 };
diff -ur gnutls-2.5.8/lib/x509/Makefile.in gnutls-2.5.8-new/lib/x509/Makefile.in
--- gnutls-2.5.8/lib/x509/Makefile.in	Sun Sep 21 12:42:49 2008
+++ gnutls-2.5.8-new/lib/x509/Makefile.in	Tue Sep 23 13:42:39 2008
@@ -566,7 +566,8 @@
 AM_CPPFLAGS = -I$(top_srcdir)/lgl -I$(top_builddir)/lgl \
 	-I$(top_srcdir)/lib -I$(top_srcdir)/includes \
 	-I$(top_builddir)/includes $(LIBOPENCDK_CFLAGS) \
-	$(LIBGCRYPT_CFLAGS) $(am__append_1) $(am__append_2)
+	$(LIBGCRYPT_CFLAGS) $(am__append_1) $(am__append_2) \
+	-DGNUTLS_INTERNAL
 noinst_LTLIBRARIES = libgnutls_x509.la
 libgnutls_x509_la_SOURCES = crl.c dn.c common.c x509.c extensions.c	\
 	rfc2818_hostname.c verify.c mpi.c privkey.c pkcs7.c	\
diff -ur gnutls-2.5.8/libextra/Makefile.in gnutls-2.5.8-new/libextra/Makefile.in
--- gnutls-2.5.8/libextra/Makefile.in	Sun Sep 21 12:42:49 2008
+++ gnutls-2.5.8-new/libextra/Makefile.in	Tue Sep 23 13:22:00 2008
@@ -662,7 +662,7 @@
 # OpenPGP
 libgnutls_extra_la_LIBADD = ../lgl/liblgnu.la gl/libxgnu.la \
 	../lib/libgnutls.la
-libgnutls_extra_la_LDFLAGS = -no-undefined $(am__append_9) \
+libgnutls_extra_la_LDFLAGS = -export-symbols-regex "^gnutls_(extra|ia|global_init|register)_.*" -no-undefined $(am__append_9) \
 	-version-info $(LT_CURRENT):$(LT_REVISION):$(LT_AGE) \
 	$(LZO_LIBS) $(am__append_11)
 all: all-recursive
diff -ur gnutls-2.5.8/src/cli.c gnutls-2.5.8-new/src/cli.c
--- gnutls-2.5.8/src/cli.c	Sun Sep 21 12:03:33 2008
+++ gnutls-2.5.8-new/src/cli.c	Tue Sep 23 13:23:01 2008
@@ -25,7 +25,9 @@
 #include <stdlib.h>
 #include <sys/types.h>
 #include <string.h>
+#ifdef HAVE_SYS_TIME_H
 #include <sys/time.h>
+#endif
 #include <sys/stat.h>
 #include <sys/socket.h>
 #include <unistd.h>
diff -ur gnutls-2.5.8/src/serv.c gnutls-2.5.8-new/src/serv.c
--- gnutls-2.5.8/src/serv.c	Sun Sep 21 12:11:09 2008
+++ gnutls-2.5.8-new/src/serv.c	Tue Sep 23 13:17:45 2008
@@ -34,7 +34,9 @@
 #include <gcrypt.h>
 #include <gnutls/extra.h>
 #include <gnutls/openpgp.h>
+#ifdef HAVE_SYS_TIME_H
 #include <sys/time.h>
+#endif
 #include <fcntl.h>
 #include <list.h>
 
diff -ur gnutls-2.5.8/src/tests.c gnutls-2.5.8-new/src/tests.c
--- gnutls-2.5.8/src/tests.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/src/tests.c	Tue Sep 23 13:35:54 2008
@@ -308,7 +308,7 @@
 
 
 static int export_true = 0;
-static gnutls_datum_t exp = { NULL, 0 }, mod =
+static gnutls_datum_t _exp = { NULL, 0 }, mod =
 
 {
 NULL, 0};
@@ -332,7 +332,7 @@
   if (ret == TEST_SUCCEED)
     {
       export_true = 1;
-      gnutls_rsa_export_get_pubkey (session, &exp, &mod);
+      gnutls_rsa_export_get_pubkey (session, &_exp, &mod);
     }
 
   return ret;
@@ -374,9 +374,9 @@
 	  if (print)
 	    printf (" Modulus [%d bits]: %s\n", mod2.size * 8, print);
 
-	  if (mod2.size != mod.size || exp2.size != exp.size ||
+	  if (mod2.size != mod.size || exp2.size != _exp.size ||
 	      memcmp (mod2.data, mod.data, mod.size) != 0 ||
-	      memcmp (exp2.data, exp.data, exp.size) != 0)
+	      memcmp (exp2.data, _exp.data, _exp.size) != 0)
 	    {
 	      printf
 		(" (server uses different public keys per connection)\n");
diff -ur gnutls-2.5.8/src/tls_test.c gnutls-2.5.8-new/src/tls_test.c
--- gnutls-2.5.8/src/tls_test.c	Sun Sep 21 11:19:08 2008
+++ gnutls-2.5.8-new/src/tls_test.c	Tue Sep 23 13:35:00 2008
@@ -26,7 +26,9 @@
 #include <string.h>
 #include <gnutls/gnutls.h>
 #include <gnutls/extra.h>
+#ifdef HAVE_SYS_TIME_H
 #include <sys/time.h>
+#endif
 #include <sys/socket.h>
 #include <tests.h>
 #include <common.h>
