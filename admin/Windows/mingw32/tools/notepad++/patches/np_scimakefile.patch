scintilla: local makefile patches

diff -r b514e1e43cf1 scintilla/win32/makefile
--- a/scintilla/win32/makefile	Fri Oct 16 07:27:21 2009 +0200
+++ b/scintilla/win32/makefile	Fri Oct 16 08:06:30 2009 +0200
@@ -6,48 +6,45 @@
 # The -fvtable-thunks option is required for older (2.9*) versions of gcc but can be removed
 # safely if using a newer version which may display warning messages.
 
+SRCDIR=@SRCDIR@
+
 .SUFFIXES: .cxx
-CC = g++
 DLLWRAP = dllwrap
-DEL = del /q
+DEL = rm -rf
 
 COMPONENT = ../bin/Scintilla.dll
 LEXCOMPONENT = ../bin/SciLexer.dll
-LEXLIB = Lexers.a
+LEXLIB = ../lib/Lexers.a
 
-ifndef NOTHUNKS
-gversion = $(word 1,$(subst ., ,$(shell g++ --version)))
-ifeq ($(gversion),2)
-THUNKFLAGS=-fvtable-thunks
-endif
-endif
+vpath %.h $(SRCDIR)/src $(SRCDIR)/include $(SRCDIR)/win32
+vpath %.cxx $(SRCDIR)/src $(SRCDIR)/win32
+vpath %.rc  $(SRCDIR)/src $(SRCDIR)/win32
+vpath %.def $(SRCDIR)/win32
 
-vpath %.h ../src ../include
-vpath %.cxx ../src
-
-LDFLAGS=-mwindows -lstdc++ -limm32 -lole32 -luuid -mno-cygwin
+override LDFLAGS+=-mwindows -limm32 -lole32 -luuid 
 # Add -MMD to get dependencies
 #CXXFLAGS = -g -pg -pedantic -Os -fno-exceptions -fvtable-thunks -fno-rtti
-INCLUDEDIRS=-I ../include -I ../src
-CXXBASEFLAGS=-Wall -Wno-missing-braces -Wno-char-subscripts -pedantic $(INCLUDEDIRS) $(THUNKFLAGS) -fno-rtti -mno-cygwin
+INCLUDEDIRS=-I $(SRCDIR)/include -I $(SRCDIR)/src
+CXXBASEFLAGS=-Wall $(INCLUDEDIRS) -O3  -fno-rtti 
 
 ifdef DEBUG
-CXXFLAGS=-DDEBUG -g $(CXXBASEFLAGS)
+override CXXFLAGS+=-DDEBUG -g $(CXXBASEFLAGS)
 else
-CXXFLAGS=-DNDEBUG -Os $(CXXBASEFLAGS)
+override CXXFLAGS+=-DNDEBUG -Os $(CXXBASEFLAGS)
 STRIPFLAG=-s
 endif
 
 .cxx.o:
 	$(CC) $(CXXFLAGS) -c $<
 
-ALL:	$(COMPONENT) $(LEXCOMPONENT) $(LEXLIB) ScintillaWinS.o WindowAccessor.o
+ALL:	deps $(COMPONENT) $(LEXCOMPONENT) $(LEXLIB) ScintillaWinS.o WindowAccessor.o
 
 clean:
 	$(DEL) *.exe *.o *.obj *.dll *.res *.map
 
 deps:
-	$(CC) -MM $(CXXFLAGS) *.cxx ../src/*.cxx >deps.mak
+	$(CC) -MM $(CXXFLAGS) $(SRCDIR)/win32/*.cxx $(SRCDIR)/src/*.cxx | sed -e 's%\([a-z]\):[\\/]%/\1/%' -e 's+\\\([^^]\)+/\1+g' > deps.mak
+	touch deps
 
 #++Autogenerated -- run src/LexGen.py to regenerate
 #**LEXOBJS=\\\n\(\*.o \)
@@ -62,7 +59,8 @@
 LexPB.o LexPerl.o LexPLM.o LexPOV.o LexPowerPro.o LexPowerShell.o \
 LexProgress.o LexPS.o LexPython.o LexR.o LexRebol.o LexRuby.o LexScriptol.o \
 LexSmalltalk.o LexSML.o LexSorcus.o LexSpecman.o LexSpice.o LexSQL.o LexTACL.o \
-LexTADS3.o LexTAL.o LexTCL.o LexTeX.o LexVB.o LexVerilog.o LexVHDL.o LexYAML.o
+LexTADS3.o LexTAL.o LexTCL.o LexTeX.o LexVB.o LexVerilog.o LexVHDL.o LexYAML.o \
+LexUser.o LexSearchResult.o LexObjC.o
 #--Autogenerated -- end of automatically generated section
 
 SOBJS	= ScintillaWin.o ScintillaBase.o Editor.o CharClassify.o Decoration.o \
@@ -70,7 +68,7 @@
 	ScintRes.o PlatWin.o PositionCache.o KeyMap.o Indicator.o LineMarker.o RESearch.o RunStyles.o \
 	Selection.o Style.o ViewStyle.o AutoComplete.o UniConversion.o PropSet.o XPM.o PerLine.o
 $(COMPONENT): $(SOBJS) Scintilla.def
-	$(DLLWRAP) --add-stdcall-alias --target i386-mingw32 -o $@ $(SOBJS) $(LDFLAGS) $(STRIPFLAG) --relocatable
+	$(DLLWRAP) --driver-name=$(CXX) -def $(SRCDIR)/win32/Scintilla.def --add-stdcall-alias --target i386-mingw32 -o $@ $(SOBJS) $(CXXLIBS) $(LDFLAGS) $(STRIPFLAG) --relocatable
 
 LOBJS	= ScintillaWinL.o ScintillaBaseL.o Editor.o CharClassify.o Decoration.o \
 	Document.o ContractionState.o CellBuffer.o CallTip.o \
@@ -78,7 +76,7 @@
 	Selection.o Style.o ViewStyle.o AutoComplete.o UniConversion.o KeyWords.o \
 	DocumentAccessor.o PropSet.o ExternalLexer.o StyleContext.o XPM.o PerLine.o $(LEXOBJS)
 $(LEXCOMPONENT): $(LOBJS) Scintilla.def
-	$(DLLWRAP) --add-stdcall-alias --target i386-mingw32 -o $@ $(LOBJS) $(LDFLAGS) $(STRIPFLAG) --relocatable
+	$(DLLWRAP) --driver-name=$(CXX) -def $(SRCDIR)/win32/Scintilla.def --add-stdcall-alias --target i386-mingw32 -o $@ $(LOBJS) $(CXXLIBS) $(LDFLAGS) $(STRIPFLAG) --relocatable
 
 $(LEXLIB): $(LEXOBJS)
 	$(AR) rc $@ $^
@@ -113,5 +111,5 @@
 	$(CC) $(CXXFLAGS) -D SCI_LEXER -c $< -o $@
 
 ScintRes.o:	ScintRes.rc PlatformRes.h
-	windres ScintRes.rc $@
+	windres --preprocessor=$(CPP) $< $@
 
