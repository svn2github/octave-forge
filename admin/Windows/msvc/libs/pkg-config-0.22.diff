diff -ur pkg-config-0.22/Makefile.in pkg-config-0.22-new/Makefile.in
--- pkg-config-0.22/Makefile.in	Mon Jun 18 23:36:04 2007
+++ pkg-config-0.22-new/Makefile.in	Tue Oct 16 10:52:47 2007
@@ -149,7 +149,7 @@
 @USE_INSTALLED_GLIB_FALSE@included_glib_includes = -I./glib-1.2.8
 @USE_INSTALLED_GLIB_TRUE@included_glib_includes = @GLIB_CFLAGS@
 @USE_INSTALLED_GLIB_FALSE@pkg_config_LDADD = glib-1.2.8/libglib.la
-@USE_INSTALLED_GLIB_TRUE@pkg_config_LDADD = @GLIB_LIBS@
+@USE_INSTALLED_GLIB_TRUE@pkg_config_LDADD = @GLIB_LIBS@ -ladvapi32
 @USE_INSTALLED_GLIB_FALSE@GLIB_SUBDIR = glib-1.2.8
 SUBDIRS = $(GLIB_SUBDIR) check
 
diff -ur pkg-config-0.22/findme.c pkg-config-0.22-new/findme.c
--- pkg-config-0.22/findme.c	Mon Jun 18 23:35:05 2007
+++ pkg-config-0.22-new/findme.c	Tue Oct 16 10:52:07 2007
@@ -28,6 +28,9 @@
 # ifdef _AIX
 #  pragma alloca
 # endif
+# ifdef _MSC_VER
+#  include <malloc.h>
+# endif
 #endif
 
 #include <stdio.h>
diff -ur pkg-config-0.22/main.c pkg-config-0.22-new/main.c
--- pkg-config-0.22/main.c	Mon Jun 18 23:35:05 2007
+++ pkg-config-0.22-new/main.c	Tue Oct 16 11:04:31 2007
@@ -292,7 +292,11 @@
     }
   else
     {
+#ifdef G_OS_WIN32
+      add_search_dirs(PKG_CONFIG_PATH, G_SEARCHPATH_SEPARATOR_S);
+#else
       add_search_dirs(PKG_CONFIG_PC_PATH, G_SEARCHPATH_SEPARATOR_S);
+#endif
     }
 
 #ifdef G_OS_WIN32
diff -ur pkg-config-0.22/pkg.c pkg-config-0.22-new/pkg.c
--- pkg-config-0.22/pkg.c	Mon Jun 18 23:35:05 2007
+++ pkg-config-0.22-new/pkg.c	Tue Oct 16 10:47:15 2007
@@ -34,7 +34,9 @@
 #endif
 
 #include <sys/types.h>
+#ifdef HAVE_DIRENT_H
 #include <dirent.h>
+#endif
 #include <string.h>
 #include <errno.h>
 #include <stdio.h>
@@ -44,6 +46,68 @@
 #include <stdlib.h>
 #include <ctype.h>
 
+#if defined (_MSC_VER) && ! defined (HAVE_DIRENT_H)
+
+#include <windows.h>
+
+struct dirent {
+	char *d_name;
+	int d_namlen;
+};
+
+typedef struct {
+	HANDLE hnd;
+	WIN32_FIND_DATA fd;
+	int dirty;
+	struct dirent d;
+	const char* current;
+} DIR;
+
+DIR* opendir(const char *name)
+{
+	DIR *d = (DIR*)malloc(sizeof(DIR));
+	static char buffer[MAX_PATH];
+
+	strncpy(buffer, name, MAX_PATH);
+	strncat(buffer, "\\*", MAX_PATH);
+	d->current = buffer;
+	d->hnd = FindFirstFile(buffer, &(d->fd));
+	if (d->hnd == INVALID_HANDLE_VALUE)
+		return NULL;
+	d->dirty = 1;
+	return d;
+}
+
+void rewinddir(DIR* d)
+{
+	if (d->hnd != INVALID_HANDLE_VALUE)
+		FindClose(d->hnd);
+	d->hnd = FindFirstFile(d->current, &(d->fd));
+	d->dirty = 1;
+}
+
+void closedir(DIR *d)
+{
+	if (d->hnd != INVALID_HANDLE_VALUE)
+		FindClose(d->hnd);
+	free(d);
+}
+
+struct dirent* readdir(DIR *d)
+{
+	if (!d->dirty)
+	{
+		if (!FindNextFile(d->hnd, &(d->fd)))
+			return NULL;
+	}
+	d->d.d_name = d->fd.cFileName;
+	d->d.d_namlen = strlen(d->fd.cFileName);
+	d->dirty = 0;
+	return &(d->d);
+}
+
+#endif
+
 static void verify_package (Package *pkg);
 
 static GHashTable *packages = NULL;
@@ -58,11 +122,19 @@
 gboolean ignore_private_libs = TRUE;
 
 static Package pkg_config_package = {
+#ifndef _MSC_VER
   .key = PACKAGE,
   .name = PACKAGE,
   .version = VERSION, /* .version */
   .description = "returns metainformation about installed libraries",
   .url = "http://pkg-config.freedesktop.org",
+#else
+  PACKAGE,
+  PACKAGE,
+  VERSION, /* .version */
+  "returns metainformation about installed libraries",
+  "http://pkg-config.freedesktop.org",
+#endif
   0 /* keep the rest as null */
 };
 
diff -ur pkg-config-0.22/popt.c pkg-config-0.22-new/popt.c
--- pkg-config-0.22/popt.c	Mon Jun 18 23:35:05 2007
+++ pkg-config-0.22-new/popt.c	Tue Oct 16 10:50:20 2007
@@ -27,6 +27,9 @@
 # ifdef _AIX
 #  pragma alloca
 # endif
+# ifdef _MSC_VER
+#  include <malloc.h>
+# endif
 #endif
 
 #include <errno.h>
diff -ur pkg-config-0.22/poptconfig.c pkg-config-0.22-new/poptconfig.c
--- pkg-config-0.22/poptconfig.c	Mon Jun 18 23:35:05 2007
+++ pkg-config-0.22-new/poptconfig.c	Tue Oct 16 10:49:33 2007
@@ -33,6 +33,9 @@
 # ifdef _AIX
 #  pragma alloca
 # endif
+# ifdef _MSC_VER
+#  include <malloc.h>
+# endif
 #endif
 
 #include <ctype.h>
diff -ur pkg-config-0.22/popthelp.c pkg-config-0.22-new/popthelp.c
--- pkg-config-0.22/popthelp.c	Mon Jun 18 23:35:05 2007
+++ pkg-config-0.22-new/popthelp.c	Tue Oct 16 10:50:35 2007
@@ -33,6 +33,9 @@
 # ifdef _AIX
 #  pragma alloca
 # endif
+# ifdef _MSC_VER
+#  include <malloc.h>
+# endif
 #endif
 
 #include <ctype.h>
diff -ur pkg-config-0.22/poptparse.c pkg-config-0.22-new/poptparse.c
--- pkg-config-0.22/poptparse.c	Mon Jun 18 23:35:05 2007
+++ pkg-config-0.22-new/poptparse.c	Tue Oct 16 10:49:50 2007
@@ -33,6 +33,9 @@
 # ifdef _AIX
 #  pragma alloca
 # endif
+# ifdef _MSC_VER
+#  include <malloc.h>
+# endif
 #endif
 
 #include <ctype.h>
